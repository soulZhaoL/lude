# Redis配置文件 - 针对AutoDL环境和Optuna高并发优化
# 此配置专门解决连接不稳定和高并发锁竞争问题

################################## 网络配置 ##################################
# 绑定所有网络接口，适用于容器环境  
bind 0.0.0.0

# 监听端口
port 6379

# 关闭保护模式，适用于内部网络
protected-mode no

# 连接超时设置 - 设为0表示永不超时，避免连接被主动断开
timeout 0

# TCP keepalive - 60秒检测一次，保持连接活跃
tcp-keepalive 60

# TCP监听队列长度 - 支持高并发连接
tcp-backlog 2048

################################## 内存配置 ##################################
# 最大内存限制 - 根据AutoDL实例调整（通常为3-4GB）
maxmemory 3gb

# 内存回收策略 - LRU回收所有键
maxmemory-policy allkeys-lru

################################## 连接配置 ##################################
# 最大客户端连接数 - 支持30个jobs的高并发
maxclients 20000

# 数据库数量
databases 16

################################## 持久化配置 ##################################
# RDB快照配置 - 适度的持久化策略
save 1800 1       # 1800秒内至少1个key变更
save 300 100      # 300秒内至少100个key变更  
save 60 10000     # 60秒内至少10000个key变更

# 后台保存错误时不停止写入 - 确保Optuna不中断
stop-writes-on-bgsave-error no

# 关闭RDB压缩和校验 - 提高性能
rdbcompression no
rdbchecksum no

# AOF持久化 - 提供更好的数据安全性
appendonly yes
appendfilename "optuna-appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

################################## 性能优化 ##################################
# 启用懒删除 - 减少阻塞操作
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# 哈希表优化
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# 列表优化
list-max-ziplist-size -2

# 集合优化  
set-max-intset-entries 512

# 有序集合优化
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

################################## 日志配置 ##################################
# 日志级别 - notice级别适合生产环境
loglevel notice

# 日志文件路径
logfile /var/log/redis/redis-server.log

# 系统日志支持
syslog-enabled no

################################## AutoDL容器环境特定配置 ##################################
# 守护进程模式 - 适合在容器中后台运行
daemonize yes

# PID文件位置
pidfile /var/run/redis/redis-server.pid

# 工作目录 - 确保有写权限
dir /var/lib/redis

# 数据库文件名
dbfilename dump.rdb

################################## 高并发优化 ##################################
# 客户端输出缓冲区限制 - 支持大量并发客户端
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# 客户端查询缓冲区限制
client-query-buffer-limit 1gb

# 协议最大批量请求大小
proto-max-bulk-len 512mb

################################## Optuna特定优化 ##################################
# 键过期策略 - 适合Optuna的使用模式
maxmemory-samples 5

# 通知配置 - 关闭不必要的事件通知
notify-keyspace-events ""

# 慢查询日志 - 用于性能监控
slowlog-log-slower-than 10000
slowlog-max-len 128

################################## 安全配置 ##################################
# 在内部网络环境下可以关闭认证
# requirepass your_password_here

# 禁用危险命令（可根据需要调整）
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command KEYS ""

################################## 监控配置 ##################################
# 延迟监控阈值
latency-monitor-threshold 100

################################## 注释说明 ##################################
# 
# 此配置文件的关键优化点：
# 
# 1. 连接稳定性：
#    - timeout 0: 永不超时，避免连接被断开
#    - tcp-keepalive 60: 定期检测连接活跃性
#    - tcp-backlog 2048: 支持高并发连接建立
# 
# 2. 内存管理：
#    - maxmemory 3gb: 适合AutoDL环境的内存限制
#    - maxmemory-policy allkeys-lru: 智能内存回收
# 
# 3. 并发支持：
#    - maxclients 20000: 支持30个jobs的高并发
#    - 优化的缓冲区设置
# 
# 4. 性能优化：
#    - 懒删除机制减少阻塞
#    - 数据结构优化减少内存占用
#    - 关闭不必要的压缩和校验
# 
# 5. AutoDL环境适配：
#    - daemonize yes: 后台运行
#    - 适合容器环境的路径配置
#    - 保护模式关闭（内部网络安全）
# 
# 使用方法：
# 1. 复制此文件到 /etc/redis/redis.conf
# 2. 创建必要的目录和权限
# 3. 使用命令启动: sudo redis-server /etc/redis/redis.conf
# 
################################## 配置结束 ##################################